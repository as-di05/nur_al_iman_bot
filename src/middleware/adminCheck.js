// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö/–∫–∞–Ω–∞–ª–∞—Ö

// Username –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–æ—Ç–∞ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫—Ç–æ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ö–∞–¥–∏—Å–∞–º–∏)
const ADMIN_USERNAME = "AS_DI05";

/**
 * Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–º–∞–Ω–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö–∞–¥–∏—Å–∞–º–∏
 */
export function isMainAdmin(ctx, next) {
  const username = ctx.from?.username;
  const userId = ctx.from?.id;

  console.log(
    `üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞: username="${username}", userId="${userId}", —Ç—Ä–µ–±—É–µ—Ç—Å—è username="${ADMIN_USERNAME}"`,
  );

  // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
  if (username && username === ADMIN_USERNAME) {
    console.log(`‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è @${username}`);
    return next();
  }

  // –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω - –æ—Ç–∫–ª–æ–Ω—è–µ–º
  console.log(
    `‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –¥–ª—è username="${username || "not set"}", userId="${userId}"`,
  );
  ctx.reply(
    `‚õîÔ∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–æ—Ç–∞.\n\n–í–∞—à username: ${username ? "@" + username : "–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"}`,
  );
  return;
}

/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π middleware - –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ callback-–∏ –¥–ª—è –≤—Å–µ—Ö –∫—Ä–æ–º–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
 * –í –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Å–µ
 * –í –≥—Ä—É–ø–ø–∞—Ö/–∫–∞–Ω–∞–ª–∞—Ö - —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ (creator)
 */
export async function onlyOwnerInGroups(ctx, next) {
  const chatType = ctx.chat?.type;

  // –í –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ
  if (chatType === "private") {
    return next();
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã –∏ callback queries
  const isCommand = ctx.message?.text?.startsWith("/");
  const isCallback = !!ctx.callbackQuery;

  if (!isCommand && !isCallback) {
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞ –∏ –Ω–µ callback - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    return next();
  }

  // –í –≥—Ä—É–ø–ø–∞—Ö –∏ –∫–∞–Ω–∞–ª–∞—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è
  if (
    chatType === "group" ||
    chatType === "supergroup" ||
    chatType === "channel"
  ) {
    try {
      const userId = ctx.from?.id;
      if (!userId) {
        return; // –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —á–∞—Ç–µ
      const chatMember = await ctx.telegram.getChatMember(ctx.chat.id, userId);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º
      if (chatMember.status === "creator") {
        return next();
      }

      // –ï—Å–ª–∏ –Ω–µ —Å–æ–∑–¥–∞—Ç–µ–ª—å - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)
      // –î–ª—è callback query –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"
      if (isCallback) {
        await ctx.answerCbQuery("‚ö†Ô∏è –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –≥—Ä—É–ø–ø—ã", {
          show_alert: true,
        });
      }

      return; // –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞:", error.message);
    }
    return;
  }

  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑—Ä–µ—à–∞–µ–º
  return next();
}
